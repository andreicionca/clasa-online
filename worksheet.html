<!DOCTYPE html>
<html lang="ro">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FiÈ™Äƒ de lucru nouÄƒ</title>
    <link rel="stylesheet" href="css/worksheet.css" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  </head>
  <body>
    <div class="container">
      <!-- SecÈ›iunea de autentificare -->
      <div id="auth-section" class="section">
        <div class="auth-header">
          <h1>FiÈ™Äƒ de lucru</h1>
          <p>Introdu datele pentru a accesa activitatea</p>
        </div>

        <div class="auth-form">
          <div class="input-group">
            <label for="student-code">Codul tÄƒu personal</label>
            <input
              type="text"
              id="student-code"
              placeholder="Codul primit de la profesor"
              autocomplete="off"
            />
          </div>

          <div class="input-group">
            <label for="worksheet-password">Parola activitÄƒÈ›ii</label>
            <input
              type="text"
              id="worksheet-password"
              placeholder="Parola activitÄƒÈ›ii"
              autocomplete="off"
            />
          </div>

          <button onclick="authenticateUser()" class="auth-btn" id="auth-btn">
            IntrÄƒ Ã®n activitate
          </button>

          <div id="auth-error" class="error hidden"></div>
          <div id="auth-loading" class="loading hidden">Se verificÄƒ datele...</div>
        </div>
      </div>

      <!-- SecÈ›iunea activitate -->
      <div id="worksheet-section" class="section hidden">
        <!-- Header activitate -->
        <div id="worksheet-header" class="worksheet-header">
          <div class="student-info">
            <span id="student-name"></span>
            <span id="worksheet-title"></span>
          </div>
          <div class="worksheet-status" id="worksheet-status"></div>
        </div>

        <!-- Progress bar -->
        <div class="progress-container">
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
          </div>
          <div class="progress-text">
            <span id="current-step">1</span> din <span id="total-steps">4</span> paÈ™i
          </div>
        </div>

        <!-- Container pentru paÈ™i -->
        <div id="steps-container" class="steps-container">
          <!-- PaÈ™ii se genereazÄƒ dinamic de worksheet.js specific -->
        </div>

        <!-- Navigare -->
        <div class="navigation">
          <button
            id="prev-btn"
            class="nav-btn secondary"
            onclick="navigateToPreviousStep()"
            disabled
          >
            â† Anterior
          </button>
          <button id="next-btn" class="nav-btn primary" onclick="navigateToNextStep()" disabled>
            UrmÄƒtorul â†’
          </button>
          <button id="finish-btn" class="nav-btn success hidden" onclick="completeWorksheet()">
            TerminÄƒ activitatea
          </button>
        </div>

        <!-- Mesaje de status -->
        <div id="worksheet-messages" class="messages"></div>
      </div>

      <!-- MODIFICAT: SecÈ›iunea de finalizare cu structura nouÄƒ -->
      <div id="completion-section" class="section hidden">
        <div class="completion-content">
          <div class="completion-header">
            <h2>ğŸ‰ Activitate finalizatÄƒ!</h2>
            <p>FelicitÄƒri! Ai completat cu succes toÈ›i paÈ™ii activitÄƒÈ›ii.</p>
          </div>

          <!-- Scorul final -->
          <div id="final-score" class="final-score">
            <!-- Populat dinamic de displayCompletionWithAIReport() -->
          </div>

          <!-- Feedback-ul AI final -->
          <div id="final-feedback" class="final-feedback">
            <!-- Populat dinamic cu raportul AI -->
          </div>

          <!-- NOUÄ‚: Container pentru butoanele de acÈ›iune -->
          <div id="completion-actions" class="completion-actions">
            <!-- Butoanele se adaugÄƒ dinamic de addCompletionActionButtons() -->
          </div>
        </div>
      </div>

      <!-- SecÈ›iunea read-only (pentru worksheets inactive) -->
      <div id="readonly-section" class="section hidden">
        <div class="readonly-header">
          <h2>Activitate Ã®nchisÄƒ</h2>
          <p>
            AceastÄƒ activitate a fost Ã®nchisÄƒ, dar poÈ›i vedea rÄƒspunsurile È™i feedback-ul primit.
          </p>
        </div>

        <div id="readonly-content" class="readonly-content">
          <!-- Progresul anterior se afiÈ™eazÄƒ aici -->
        </div>

        <button onclick="goToHomePage()" class="home-btn">Ãnapoi la pagina principalÄƒ</button>
      </div>
    </div>

    <!-- Template pentru pas cu grile -->
    <template id="grila-step-template">
      <div class="step" data-type="grila">
        <div class="step-header">
          <h3 class="step-title">Pas <span class="step-number"></span></h3>
          <div class="step-type">Alegere multiplÄƒ</div>
        </div>

        <div class="question">
          <p class="question-text"></p>
        </div>

        <div class="options" data-step=""></div>

        <div class="step-actions">
          <button class="submit-step-btn" onclick="submitCurrentStep()">VerificÄƒ rÄƒspunsul</button>
        </div>

        <div class="feedback hidden">
          <div class="feedback-content">
            <div class="feedback-score"></div>
            <div class="feedback-text"></div>
          </div>
        </div>
      </div>
    </template>

    <!-- Template pentru pas cu rÄƒspuns scurt -->
    <template id="short-step-template">
      <div class="step" data-type="short">
        <div class="step-header">
          <h3 class="step-title">Pas <span class="step-number"></span></h3>
          <div class="step-type">RÄƒspuns scurt</div>
        </div>

        <div class="question">
          <p class="question-text"></p>
        </div>

        <div class="answer-input">
          <textarea
            class="short-answer"
            rows="4"
            placeholder="Scrie rÄƒspunsul tÄƒu aici..."
          ></textarea>
          <div class="word-count">0 cuvinte</div>
        </div>

        <div class="step-actions">
          <button class="submit-step-btn" onclick="submitCurrentStep()">Trimite rÄƒspunsul</button>
        </div>

        <div class="feedback hidden">
          <div class="feedback-content">
            <div class="feedback-score"></div>
            <div class="feedback-text"></div>
          </div>
        </div>
      </div>
    </template>

    <!-- Scripts Ã®n ordine: common.js apoi worksheet.js specific -->
    <script src="js/common.js"></script>
    <script>
      // Variabile globale pentru starea aplicaÈ›iei
      let authenticationData = null;
      let currentStepIndex = 0;
      let worksheetSteps = [];
      let studentProgress = {};

      // ÃncÄƒrcarea paginii
      document.addEventListener('DOMContentLoaded', function () {
        initializePage();
      });

      // FuncÈ›ii de legÄƒturÄƒ Ã®ntre common.js È™i worksheet.js specific
      function authenticateUser() {
        // ApeleazÄƒ funcÈ›ia din common.js
        performAuthentication();
      }

      function navigateToNextStep() {
        // ApeleazÄƒ funcÈ›ia din common.js
        moveToNextStep();
      }

      function navigateToPreviousStep() {
        // ApeleazÄƒ funcÈ›ia din common.js
        moveToPreviousStep();
      }

      function completeWorksheet() {
        // FuncÈ›ie pentru finalizarea activitÄƒÈ›ii
        finishCurrentWorksheet();
      }

      // MODIFICAT: FuncÈ›ii pentru completarea activitÄƒÈ›ii
      function reviewAllSteps() {
        // FuncÈ›ie pentru review
        showWorksheetReview();
      }

      function goToHomePage() {
        // MODIFICAT: FoloseÈ™te funcÈ›ia din worksheet.js pentru confirmarea acÈ›iunii
        if (typeof handleGoHome === 'function') {
          handleGoHome();
        } else {
          // Fallback direct
          window.location.href = '/index.html';
        }
      }

      // Callback pentru dupÄƒ autentificare - va fi apelat din common.js
      function onAuthenticationSuccess(authData) {
        authenticationData = authData;

        // DeterminÄƒ ce worksheet.js sÄƒ Ã®ncÄƒrce pe baza datelor
        const worksheetPath = `worksheets/${authData.worksheet.subject}/${authData.worksheet.grade}/${authData.worksheet.topic}/worksheet.js`;

        // ÃncarcÄƒ scriptul specific
        loadWorksheetScript(worksheetPath);
      }

      // ÃncarcÄƒ scriptul specific pentru worksheet
      function loadWorksheetScript(scriptPath) {
        const script = document.createElement('script');
        script.src = scriptPath;
        script.onload = function () {
          // DupÄƒ ce s-a Ã®ncÄƒrcat scriptul, iniÈ›ializeazÄƒ worksheet-ul
          if (typeof initializeSpecificWorksheet === 'function') {
            initializeSpecificWorksheet(authenticationData);
          } else {
            console.error(
              'FuncÈ›ia initializeSpecificWorksheet nu a fost gÄƒsitÄƒ Ã®n scriptul specific'
            );
          }
        };
        script.onerror = function () {
          console.error('Nu s-a putut Ã®ncÄƒrca scriptul specific:', scriptPath);
          showMessage('Eroare la Ã®ncÄƒrcarea activitÄƒÈ›ii', 'error');
        };
        document.head.appendChild(script);
      }

      // FuncÈ›ii placeholder care vor fi implementate Ã®n scripturile specifice
      function submitCurrentStep() {
        if (typeof submitCurrentStepWorksheet === 'function') {
          submitCurrentStepWorksheet();
        } else {
          console.error('FuncÈ›ia submitCurrentStepWorksheet nu este definitÄƒ');
        }
      }

      function finishCurrentWorksheet() {
        if (typeof finalizeWorksheet === 'function') {
          finalizeWorksheet();
        } else {
          console.error('FuncÈ›ia finalizeWorksheet nu este definitÄƒ');
        }
      }

      function showWorksheetReview() {
        if (typeof displayWorksheetReview === 'function') {
          displayWorksheetReview();
        } else {
          console.error('FuncÈ›ia displayWorksheetReview nu este definitÄƒ');
        }
      }
    </script>
  </body>
</html>
