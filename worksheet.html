<!DOCTYPE html>
<html lang="ro">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fișă de lucru nouă</title>
    <link rel="stylesheet" href="css/worksheet.css" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  </head>
  <body>
    <div class="container">
      <!-- Secțiunea de autentificare -->
      <div id="auth-section" class="section">
        <div class="auth-header">
          <h1>Fișă de lucru</h1>
          <p>Introdu datele pentru a accesa activitatea</p>
        </div>

        <div class="auth-form">
          <div class="input-group">
            <label for="student-code">Codul tău personal</label>
            <input
              type="text"
              id="student-code"
              placeholder="Codul primit de la profesor"
              autocomplete="off"
            />
          </div>

          <div class="input-group">
            <label for="worksheet-password">Parola activității</label>
            <input
              type="text"
              id="worksheet-password"
              placeholder="Parola activității"
              autocomplete="off"
            />
          </div>

          <button onclick="authenticateUser()" class="auth-btn" id="auth-btn">
            Intră în activitate
          </button>

          <div id="auth-error" class="error hidden"></div>
          <div id="auth-loading" class="loading hidden">Se verifică datele...</div>
        </div>
      </div>

      <!-- NOUĂ: Secțiunea pentru activitate deja făcută -->
      <div id="previous-attempt-section" class="section hidden">
        <div class="previous-attempt-header">
          <h2>Activitate deja completată</h2>
          <p>Ai mai făcut această activitate anterior. Iată rezultatele tale:</p>
        </div>

        <div class="previous-attempt-content">
          <!-- Informații despre student și activitate -->
          <div class="previous-attempt-info">
            <div class="student-worksheet-info">
              <span id="prev-student-name" class="student-name"></span>
              <span id="prev-worksheet-title" class="worksheet-title"></span>
            </div>
            <div id="prev-attempt-details" class="attempt-details"></div>
          </div>

          <!-- Scorul anterior -->
          <div class="previous-score-section">
            <h3>Rezultatul tău anterior</h3>
            <div id="previous-score" class="previous-score">
              <!-- Populat dinamic cu scorul anterior -->
            </div>
          </div>

          <!-- Raportul AI anterior -->
          <div class="previous-report-section">
            <h3>Raportul profesorului AI</h3>
            <div id="previous-report" class="previous-report">
              <!-- Populat dinamic cu raportul AI anterior -->
            </div>
          </div>

          <!-- Opțiuni pentru utilizator -->
          <div class="previous-attempt-options">
            <h3>Ce dorești să faci?</h3>
            <div class="options-buttons">
              <button
                id="retry-exercise-btn"
                class="option-btn primary"
                onclick="handleRetryFromPrevious()"
              >
                Refă exercițiul din nou
              </button>
              <button id="go-home-btn" class="option-btn secondary" onclick="goToHomePage()">
                Înapoi la pagina principală
              </button>
            </div>
            <div class="retry-info">
              <p id="retry-info-text" class="info-text">
                <!-- Populat dinamic cu informații despre încercări rămase -->
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Secțiunea activitate -->
      <div id="worksheet-section" class="section hidden">
        <!-- Header activitate -->
        <div id="worksheet-header" class="worksheet-header">
          <div class="student-info">
            <span id="student-name"></span>
            <span id="worksheet-title"></span>
          </div>
          <div class="worksheet-status" id="worksheet-status"></div>
        </div>

        <!-- Progress bar -->
        <div class="progress-container">
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
          </div>
          <div class="progress-text">
            <span id="current-step">1</span> din <span id="total-steps">4</span> pași
          </div>
        </div>

        <!-- Container pentru pași -->
        <div id="steps-container" class="steps-container">
          <!-- Pașii se generează dinamic de worksheet.js specific -->
        </div>

        <!-- Navigare -->
        <div class="navigation">
          <button
            id="prev-btn"
            class="nav-btn secondary"
            onclick="navigateToPreviousStep()"
            disabled
          >
            ← Anterior
          </button>
          <button id="next-btn" class="nav-btn primary" onclick="navigateToNextStep()" disabled>
            Următorul →
          </button>
          <button id="finish-btn" class="nav-btn success hidden" onclick="completeWorksheet()">
            Termină activitatea
          </button>
        </div>

        <!-- Mesaje de status -->
        <div id="worksheet-messages" class="messages"></div>
      </div>

      <!-- Secțiunea de finalizare cu structura nouă -->
      <div id="completion-section" class="section hidden">
        <div class="completion-content">
          <div class="completion-header">
            <h2>Activitate finalizată!</h2>
            <p>Felicitări! Ai completat cu succes toți pașii activității.</p>
          </div>

          <!-- Scorul final -->
          <div id="final-score" class="final-score">
            <!-- Populat dinamic de displayCompletionWithAIReport() -->
          </div>

          <!-- Feedback-ul AI final -->
          <div id="final-feedback" class="final-feedback">
            <!-- Populat dinamic cu raportul AI -->
          </div>

          <!-- Container pentru butoanele de acțiune -->
          <div id="completion-actions" class="completion-actions">
            <!-- Butoanele se adaugă dinamic de addCompletionActionButtons() -->
          </div>
        </div>
      </div>

      <!-- Secțiunea read-only (pentru worksheets inactive) -->
      <div id="readonly-section" class="section hidden">
        <div class="readonly-header">
          <h2>Activitate închisă</h2>
          <p>
            Această activitate a fost închisă, dar poți vedea răspunsurile și feedback-ul primit.
          </p>
        </div>

        <div id="readonly-content" class="readonly-content">
          <!-- Progresul anterior se afișează aici -->
        </div>

        <button onclick="goToHomePage()" class="home-btn">Înapoi la pagina principală</button>
      </div>
    </div>

    <!-- Template pentru pas cu grile -->
    <template id="grila-step-template">
      <div class="step" data-type="grila">
        <div class="step-header">
          <h3 class="step-title">sarcina <span class="step-number"></span></h3>
          <div class="step-type">Alegere multiplă</div>
          <div class="step-points hidden"><!-- se va afișa dinamic --></div>
        </div>

        <div class="question">
          <p class="question-text"></p>
        </div>

        <div class="options" data-step=""></div>

        <div class="step-actions">
          <button class="submit-step-btn" onclick="submitCurrentStep()">Verifică răspunsul</button>
        </div>

        <div class="feedback hidden">
          <div class="feedback-content">
            <div class="feedback-score"></div>
            <div class="feedback-text"></div>
          </div>
        </div>
      </div>
    </template>

    <!-- Template pentru sarcina cu răspuns scurt -->
    <template id="short-step-template">
      <div class="step" data-type="short">
        <div class="step-header">
          <h3 class="step-title">sarcina <span class="step-number"></span></h3>
          <div class="step-type">Răspuns scurt</div>
          <div class="step-points hidden"><!-- se va afișa dinamic --></div>
        </div>

        <div class="question">
          <p class="question-text"></p>
        </div>

        <div class="answer-input">
          <textarea
            class="short-answer"
            rows="4"
            placeholder="Scrie răspunsul tău aici..."
          ></textarea>
          <div class="word-count">0 cuvinte</div>
        </div>

        <div class="step-actions">
          <button class="submit-step-btn" onclick="submitCurrentStep()">Trimite răspunsul</button>
        </div>

        <div class="feedback hidden">
          <div class="feedback-content">
            <div class="feedback-score"></div>
            <div class="feedback-text"></div>
          </div>
        </div>
      </div>
    </template>

    <!-- Scripts în ordine: common.js apoi worksheet.js specific -->
    <script src="js/common.js"></script>
    <script>
      // Variabile globale pentru starea aplicației
      let authenticationData = null;
      let currentStepIndex = 0;
      let worksheetSteps = [];
      let studentProgress = {};

      // Încărcarea paginii
      document.addEventListener('DOMContentLoaded', function () {
        initializePage();
      });

      // Funcții de legătură între common.js și worksheet.js specific
      function authenticateUser() {
        // Apelează funcția din common.js
        performAuthentication();
      }

      function navigateToNextStep() {
        // Apelează funcția din common.js
        moveToNextStep();
      }

      function navigateToPreviousStep() {
        // Apelează funcția din common.js
        moveToPreviousStep();
      }

      function completeWorksheet() {
        // Funcție pentru finalizarea activității
        finishCurrentWorksheet();
      }

      function reviewAllSteps() {
        // Funcție pentru review
        showWorksheetReview();
      }

      function goToHomePage() {
        // Folosește funcția din worksheet.js pentru confirmarea acțiunii
        if (typeof handleGoHome === 'function') {
          handleGoHome();
        } else {
          // Fallback direct
          window.location.href = '/index.html';
        }
      }

      // NOUĂ: Funcție pentru reluarea exercițiului din secțiunea anterioară
      function handleRetryFromPrevious() {
        if (typeof startNewAttemptFromPrevious === 'function') {
          startNewAttemptFromPrevious();
        } else {
          console.error('Funcția startNewAttemptFromPrevious nu este definită');
        }
      }

      // Callback pentru după autentificare - va fi apelat din common.js
      function onAuthenticationSuccess(authData) {
        authenticationData = authData;

        // Determină ce worksheet.js să încărce pe baza datelor
        const worksheetPath = `worksheets/${authData.worksheet.subject}/${authData.worksheet.grade}/${authData.worksheet.topic}/worksheet.js`;

        // Încarcă scriptul specific
        loadWorksheetScript(worksheetPath);
      }

      // Încarcă scriptul specific pentru worksheet
      function loadWorksheetScript(scriptPath) {
        const script = document.createElement('script');
        script.src = scriptPath;
        script.onload = function () {
          // După ce s-a încărcat scriptul, inițializează worksheet-ul
          if (typeof initializeSpecificWorksheet === 'function') {
            initializeSpecificWorksheet(authenticationData);
          } else {
            console.error(
              'Funcția initializeSpecificWorksheet nu a fost găsită în scriptul specific'
            );
          }
        };
        script.onerror = function () {
          console.error('Nu s-a putut încărca scriptul specific:', scriptPath);
          showMessage('Eroare la încărcarea activității', 'error');
        };
        document.head.appendChild(script);
      }

      // Funcții placeholder care vor fi implementate în scripturile specifice
      function submitCurrentStep() {
        if (typeof submitCurrentStepWorksheet === 'function') {
          submitCurrentStepWorksheet();
        } else {
          console.error('Funcția submitCurrentStepWorksheet nu este definită');
        }
      }

      function finishCurrentWorksheet() {
        if (typeof finalizeWorksheet === 'function') {
          finalizeWorksheet();
        } else {
          console.error('Funcția finalizeWorksheet nu este definită');
        }
      }

      function showWorksheetReview() {
        if (typeof displayWorksheetReview === 'function') {
          displayWorksheetReview();
        } else {
          console.error('Funcția displayWorksheetReview nu este definită');
        }
      }
    </script>
  </body>
</html>
